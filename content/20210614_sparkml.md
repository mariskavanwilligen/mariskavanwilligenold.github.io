Title: Machine Learning with Spark
Date: 2021-06-14 15:36
Tags: ML, Spark, sklearn
Slug: ml-spark
Authors: Mariska van Willigen
Summary:


``` js

from pyspark.ml.regression import RandomForestRegressor
from pyspark.ml.tuning import ParamGridBuilder,  CrossValidator
from pyspark.ml.feature import VectorAssembler , StringIndexer, MinMaxScaler
from pyspark.ml import Pipeline
from pyspark.ml.evaluation import RegressionEvaluator
from pyspark.context import SparkContext
from pyspark.sql.session import SparkSession
import pyspark.sql.functions as F

sc = SparkContext('local')
spark = SparkSession(sc)
```


```js
boston = spark.read.csv('Boston.csv', header=True, inferSchema=True)

boston = (boston.dropna()
         .drop('_c0')
         .withColumnRenamed('medv', 'label'))

feature_cols = ['crim',
 'zn',
 'indus',
 'chas',
 'nox',
 'rm',
 'age',
 'dis',
 'rad',
 'tax',
 'ptratio',
 'black',
 'lstat']

train_df, test_df = boston.randomSplit([0.8, 0.2], seed=707)

print("Train count:", train_df.count())
print('Test count:', test_df.count())
```


### Without grid search and cross validation
```js
assembler = VectorAssembler(inputCols=feature_cols, outputCol='features_vector')
scaler = MinMaxScaler(inputCol='features_vector', outputCol='features')
regressor = RandomForestRegressor()

pipeline = Pipeline(stages=[assembler, scaler, regressor])
with_predictions = pipeline.fit(train_df).transform(test_df)

evaluator = RegressionEvaluator()
print("MSE:", evaluator.evaluate(with_predictions, {evaluator.metricName: "mse"}))
print("R2:", evaluator.evaluate(with_predictions, {evaluator.metricName: "r2"}))
```


# With Grid search and crossvalidation
```js
assembler = VectorAssembler(inputCols=feature_cols, outputCol='features_vector')
scaler = MinMaxScaler(inputCol='features_vector', outputCol='features')
regressor = RandomForestRegressor()

pipeline = Pipeline(stages=[assembler, scaler, regressor])

num_trees = [1, 3, 40, 50, 60, 100]
grid = (
   ParamGridBuilder()
   .addGrid(regressor.numTrees, num_trees)
   .build()
)
cv = (
   CrossValidator()
   .setEstimator(pipeline)
   .setEvaluator(RegressionEvaluator(metricName='mse'))
   .setEstimatorParamMaps(grid)
   .setNumFolds(5)
)
```

```js
cv_model = cv.fit(train_df)

with_predictions = cv_model.bestModel.transform(test_df)
with_predictions.select(["features", "label", "prediction"]).limit(5).toPandas()

evaluator = RegressionEvaluator()
print("MSE:", evaluator.evaluate(with_predictions, {evaluator.metricName: "mse"}))
print("R2:", evaluator.evaluate(with_predictions, {evaluator.metricName: "r2"}))
```


