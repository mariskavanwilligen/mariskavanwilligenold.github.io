Title: Machine Learning with Spark
Date: 2021-06-14 15:36
Tags: ML, Spark, sklearn
Slug: ml-spark
Authors: Mariska van Willigen
Summary:


``` js

from pyspark.ml.regression import RandomForestRegressor
from pyspark.ml.tuning import ParamGridBuilder,  CrossValidator
from pyspark.ml.feature import VectorAssembler , StringIndexer, MinMaxScaler
from pyspark.ml import Pipeline
from pyspark.ml.evaluation import RegressionEvaluator
from pyspark.context import SparkContext
from pyspark.sql.session import SparkSession
import pyspark.sql.functions as F

sc = SparkContext('local')
spark = SparkSession(sc)
```

## Aim: predict prices for houses in Boston

Features:
> **CRIM** - per capita crime rate by town
> **ZN** - proportion of residential land zoned for lots over 25,000 sq.ft.
> **INDUS** - proportion of non-retail business acres per town
> **RM** - average number of rooms per dwelling
> **AGE** - proportion of owner-occupied units built prior to 1940
> **DIS** - weighted distances to five Boston employment centres

## Loading the dataset
```js
boston = spark.read.csv('Boston.csv', header=True, inferSchema=True)

boston = (boston.dropna()
         .drop('_c0')
         .withColumnRenamed('medv', 'label'))

feature_cols = ['crim',
 'zn',
 'indus',
 'chas',
 'nox',
 'rm',
 'age',
 'dis',
 'rad',
 'tax',
 'ptratio',
 'black',
 'lstat']

boston.limit(5).toPandas()
```
![](/images/mlspark/display.png)

## Split in trainset and testset
```js
train_df, test_df = boston.randomSplit([0.8, 0.2], seed=707)

print("Train count:", train_df.count())
print('Test count:', test_df.count())
```
![](/images/mlspark/counts.png)

### Fitting a simpel Random forest model without grid search and cross validation
# Pipeline:
Build ML workflows as a chain of Transformers and Estimators.

> **DataFrame**: stores data (e.g., input, features, labels, predictions).
> **Transformer**: transforms one DataFrame into another DataFrame.
> **Estimator**: fits on a DataFrame and produces a Transformer.
> **Parameter**: Common API for specifying parameters.

It is necessary to call your columns in a list 'feature_cols' which will be transformed with a VectorAssembler into a features_vector.
The outcome variable y should always have the columnname 'label'.

After the pipeline has been set up and the model has been fitted, the predictions can be derived with .transform()

```js
assembler = VectorAssembler(inputCols=feature_cols, outputCol='features_vector')
scaler = MinMaxScaler(inputCol='features_vector', outputCol='features')
regressor = RandomForestRegressor()

pipeline = Pipeline(stages=[assembler, scaler, regressor])
with_predictions = pipeline.fit(train_df).transform(test_df)

evaluator = RegressionEvaluator()
print("MSE:", evaluator.evaluate(with_predictions, {evaluator.metricName: "mse"}))
print("R2:", evaluator.evaluate(with_predictions, {evaluator.metricName: "r2"}))
```
![](/images/mlspark/withoutgrid.png)

# With Grid search and crossvalidation
A gridsearch can be performed to find the optimal number of trees.
```js
assembler = VectorAssembler(inputCols=feature_cols, outputCol='features_vector')
scaler = MinMaxScaler(inputCol='features_vector', outputCol='features')
regressor = RandomForestRegressor()

pipeline = Pipeline(stages=[assembler, scaler, regressor])

num_trees = [1, 3, 40, 50, 60, 100]
grid = (
   ParamGridBuilder()
   .addGrid(regressor.numTrees, num_trees)
   .build()
)
cv = (
   CrossValidator()
   .setEstimator(pipeline)
   .setEvaluator(RegressionEvaluator(metricName='mse'))
   .setEstimatorParamMaps(grid)
   .setNumFolds(5)
)
```
A CrossValidator is created and the model, evaluator and grid has been sepcified. The cv_model now contains the best model based on the MSE.
```js
cv_model = cv.fit(train_df)

with_predictions = cv_model.bestModel.transform(test_df)
with_predictions.select(["features", "label", "prediction"]).limit(5).toPandas()

evaluator = RegressionEvaluator()
print("MSE:", evaluator.evaluate(with_predictions, {evaluator.metricName: "mse"}))
print("R2:", evaluator.evaluate(with_predictions, {evaluator.metricName: "r2"}))
```
![](/images/mlspark/withgrid.png)

